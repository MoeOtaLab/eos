var P=Object.defineProperty,T=Object.defineProperties;var I=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var R=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var $=(n,e,t)=>e in n?P(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,b=(n,e)=>{for(var t in e||(e={}))R.call(e,t)&&$(n,t,e[t]);if(O)for(var t of O(e))L.call(e,t)&&$(n,t,e[t]);return n},v=(n,e)=>T(n,I(e));var x=(n,e,t)=>($(n,typeof e!="symbol"?e+"":e,t),t);import{w,j as jsx,R as ReactFlowProvider,h,E,r as react,u as useUpdateNodeInternals,F as Fragment,i as isEdge,a as jsxs,c as classnames,b as React,H as Handle$1,P as Position,d as useStoreActions,e as useStoreState,f as ReactFlow,g as index$1,B as BackgroundVariant,k as index$2,l as index$1$1,m as removeElements,n as addEdge,o as isNode,S as Subject,p as useObservable,q as ReactDOM}from"./vendor.449bb51f.js";const p=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}};p();var index="";const DiagramsContext=w({elements:[],setElements:()=>{},updateElement:()=>{}});function useDiagramsContext(){return h(DiagramsContext)}function useDiagramsContextSelector(n){return E(DiagramsContext,n)}function useDiagramsState(){return{elements:useDiagramsContextSelector(e=>e.elements)}}const DiagramsContextInnerProvider=n=>{const{children:e}=n,[t,o]=react.exports.useState([]),r=useUpdateNodeInternals(),s=react.exports.useCallback((c,u,i)=>{!c||(o(l=>{var _;const a=l.findIndex(j=>j.id===c);if(a<0)return l;const g=[...l],d=(_=g.splice(a,1))==null?void 0:_[0],f=typeof u=="function"?u(d):u;return g.concat(f)}),i&&setTimeout(()=>{r(c)},0))},[r]);return jsx(DiagramsContext.Provider,{value:{elements:t,setElements:o,updateElement:s},children:e})},DiagramsContextProvider=n=>{const{children:e}=n;return jsx(ReactFlowProvider,{children:jsx(DiagramsContextInnerProvider,{children:e})})};function getRandomId(){return`$flow_${Math.random().toString(36).substr(2,5)}`}function isSameTargetHandle(n,e){return n.target===e.target&&n.targetHandle===e.targetHandle}function isSameSourceHandle(n,e){return n.source===e.source&&n.sourceHandle===e.sourceHandle}class Operator{constructor(e="Operator",t){x(this,"id",getRandomId());x(this,"position",{x:0,y:0});x(this,"type","OperatorNode");x(this,"data",{});x(this,"style");x(this,"className");x(this,"targetPosition");x(this,"sourcePosition");x(this,"isHidden");x(this,"draggable");x(this,"selectable");x(this,"connectable");Object.assign(this,v(b({},t),{data:b(b({operatorType:e},this.data),t==null?void 0:t.data)}))}static generateOperatorIcon(){return jsx("div",{children:this.name})}static generateAttributeControl(e){const{value:t,actions:o}=e;function r(s){t.data.label=s,o.updateElement(t.id,t)}return jsx(Fragment,{children:jsx("input",{placeholder:"input label",style:{width:"100%",maxWidth:"none"},value:t.data.label,onChange:s=>r(s.target.value)})})}static generateOperation(e){return""}}var css$4={"attribute-control":"_attribute-control_w1f3b_1"};const LogicStateStoreSymbol="logicStateStore";function convertToGraph(n){const e=n.filter(o=>isEdge(o)),t=new Map(n.filter(o=>!isEdge(o)).map(o=>[o.id,{id:o.id,operator:o,sourceLink:{}}]));return e.forEach(o=>{const r=t.get(o.target),s=t.get(o.source);if(!r||!s||!(o==null?void 0:o.targetHandle)||!(o==null?void 0:o.sourceHandle)){console.warn("found useless target/source edge: ",o);return}if(r.sourceLink[o.targetHandle]){console.warn("found duplicate input source: ",o);return}r.sourceLink[o.targetHandle]={target:s,handler:o.sourceHandle}}),[...t.values()]}function generateLogicState(n){const e=convertToGraph(n),t=`
    const ${LogicStateStoreSymbol} = new Map();
    // initial
    ${e.map(s=>`
      ${LogicStateStoreSymbol}.set('${s.id}', new Rx.Subject());
    `).join(`
`)}
  `,o=e.map(s=>{var i,l,a;return`
      (function () {
        let exports;
        ${(a=OperatorMap.get((l=(i=s.operator)==null?void 0:i.data)==null?void 0:l.operatorType))==null?void 0:a.generateOperation(s)}
        const recordOnlySubject = ${LogicStateStoreSymbol}.get('${s.id}');
        exports?.subscribe(value => recordOnlySubject?.next(value));
      })();
    `}).join(`
`),r=`
    function main() {
      ${t}
      ${o}
      return ${LogicStateStoreSymbol};
    }

    main();
  `;return console.log(r),r}function combineLogic(...n){return n.flat(1/0).filter(Boolean).join(`
`)}function getState(n,e){return`const ${e} = ${LogicStateStoreSymbol}.get('${n}');`}function generateArray(n){return`[${n.join(",")}]`}function generateFunction(n,e,...t){return`${e?`const ${e} = `:""}${n}(${t.join(", ")});`}function generateObject(n){return`{${Object.entries(n).map(([e,t])=>`${e}: ${t}`).join(",")}}`}function exportValue(n){return typeof n=="object"?`exports = ${generateObject(n)}`:`exports = ${n}`}class AddOperator extends Operator{constructor(e){super("AddOperator",e);this.data=b(v(b({},this.data),{targetPorts:[{label:"Input_1",id:"Input_1"},{label:"Input_2",id:"Input_2"}],sourcePorts:[{label:"Result",id:"Result"}]}),e==null?void 0:e.data)}static generateAttributeControl(e){const{value:t,actions:o}=e,r=t.data.targetPorts||[],s=()=>{const u={label:`Input_${r.length+1}`,id:`Input_${r.length+1}`};t.data.targetPorts=r.concat(u),o.updateElement(t.id,t,!0)},c=()=>{var u;r.length>1&&((u=t.data.targetPorts)==null||u.pop(),o.updateElement(t.id,t,!0))};return jsxs("div",{className:css$4["attribute-control"],children:[Operator.generateAttributeControl(e),jsx("button",{onClick:s,children:"add Input Port"}),jsx("button",{disabled:r.length<=1,onClick:c,children:"delete Input Port"})]})}static generateOperation(e){const t=Object.entries(e.sourceLink),o=combineLogic(t.map(([r,s])=>getState(s.target.id,r)),generateFunction("operations.AddOperator.addOperation","addResult$",generateArray(t.map(([r])=>r)),generateArray(t.map(([,r])=>`'${r.handler}'`))),exportValue("addResult$"));return console.log(o),o}}class SourceOperator extends Operator{static generateAttributeControl(e){var s;const{value:t,actions:o}=e;function r(c){t.data.dataSourceId=c,o.updateElement(t.id,t)}return jsxs("div",{children:[super.generateAttributeControl(e),jsx("label",{children:"\u8BF7\u9009\u62E9\u6570\u636E\u6765\u6E90"}),jsx("input",{value:((s=t.data)==null?void 0:s.dataSourceId)||"",onChange:c=>r(c.target.value)})]})}constructor(e){super("SourceOperator",e);this.data=b(v(b({},this.data),{sourcePorts:[{label:"Source",id:"Source"}]}),e==null?void 0:e.data)}static generateOperation(e){return combineLogic(`const result = link.getValueSource('${e.operator.data.dataSourceId}');`,`console.log({result, type: '${e.operator.data.dataSourceId}'})`,exportValue("result"))}}class TargetOperator extends Operator{static generateAttributeControl(e){var s;const{value:t,actions:o}=e;function r(c){t.data.dataSourceId=c,o.updateElement(t.id,t)}return jsxs("div",{children:[super.generateAttributeControl(e),jsx("label",{children:"\u8BF7\u9009\u62E9\u8F93\u51FA\u4F4D\u7F6E"}),jsx("input",{value:((s=t.data)==null?void 0:s.dataSourceId)||"",onChange:c=>r(c.target.value)})]})}constructor(e){super("TargetOperator",e);this.data=b(v(b({},this.data),{targetPorts:[{label:"Target",id:"Target"}],dataSourceId:"input8"}),e==null?void 0:e.data)}static generateOperation(e){const t=Object.values(e.sourceLink)[0];return combineLogic(getState(t.target.id,"target"),exportValue("target"))}}const OperatorRecord={AddOperator,SourceOperator,TargetOperator},OperatorMap=new Map(Object.entries(OperatorRecord)),container$1="_container_1bovl_1",content="_content_1bovl_6";var css$3={container:container$1,content};const MODEL_FORMAT="model",OperatorPanel=()=>{const n=e=>t=>{t.dataTransfer.setData(MODEL_FORMAT,e),t.dataTransfer.dropEffect="copy",t.dataTransfer.effectAllowed="all"};return jsxs("div",{className:css$3.container,children:[jsx("div",{className:css$3.title,children:"Operator Panel"}),jsx("div",{className:css$3.content,children:[...OperatorMap.entries()].map(([e,t])=>jsx("div",{style:{cursor:"pointer"},draggable:!0,onDragStart:n(e),children:(t==null?void 0:t.generateOperatorIcon())||e},e))})]})},node__container="_node__container_1uch9_1",node__content="_node__content_1uch9_11",source="_source_1uch9_84",target="_target_1uch9_112",node__title="_node__title_1uch9_143";var css$2={node__container,node__content,"is-selected":"_is-selected_1uch9_20","node__port-list":"_node__port-list_1uch9_23","is-sub-list":"_is-sub-list_1uch9_37","node__port-children":"_node__port-children_1uch9_40","node__port-dot":"_node__port-dot_1uch9_57","is-last":"_is-last_1uch9_66",source,target,node__title,"node__port-expand-trigger":"_node__port-expand-trigger_1uch9_148","is-children-hidden":"_is-children-hidden_1uch9_163","node__port-expand-line":"_node__port-expand-line_1uch9_174","node__port-label":"_node__port-label_1uch9_187"};const PortList=n=>{const{value:e=[],type:t,nestLevel:o=0}=n,[r,s]=react.exports.useState([]);function c(i){return!(r==null?void 0:r.includes(i))}function u(i){return()=>{s(l=>{const a=[...l];return(a==null?void 0:a.includes(i))?a.splice(a.indexOf(i)):a.push(i),a})}}return jsx("ul",{className:classnames(css$2["node__port-list"],css$2[t],{[css$2["is-sub-list"]]:o}),style:{"--nest-level":o},children:e.map((i,l)=>{var d,f;const a=Boolean((d=i==null?void 0:i.children)==null?void 0:d.length),g=c(i.id);return jsxs(React.Fragment,{children:[jsxs("li",{className:classnames({[css$2["node__port-expand"]]:a,[css$2["is-last"]]:l===e.length-1}),children:[Boolean(o)&&!a&&jsx("div",{className:css$2["node__port-dot"]}),a&&jsxs(Fragment,{children:[jsx("div",{className:classnames(css$2["node__port-expand-trigger"],{[css$2["is-children-hidden"]]:g}),onClick:u(i.id),children:jsx("svg",{viewBox:"0 0 1024 1024",focusable:"false","data-icon":"caret-down",width:"1em",height:"1em",fill:"currentColor","aria-hidden":"true",children:jsx("path",{d:"M840.4 300H183.6c-19.7 0-30.7 20.8-18.5 35l328.4 380.8c9.4 10.9 27.5 10.9 37 0L858.9 335c12.2-14.2 1.2-35-18.5-35z"})})}),!g&&jsx("div",{className:css$2["node__port-expand-line"]})]}),jsx("div",{className:css$2["node__port-label"],children:i.label}),jsx(Handle$1,{type:t,position:t==="source"?Position.Right:Position.Left,id:i.id,isConnectable:(f=i.isConnectable)!=null?f:!0})]}),!g&&a&&jsx("li",{className:css$2["node__port-children"],children:jsx(PortList,{value:i.children,nestLevel:o+1,type:t})})]},i.id)})})},OperatorNode=n=>{const{data:e,selected:t}=n,o=e==null?void 0:e.operatorType,r=[{type:"source",value:e.sourcePorts},{type:"target",value:e.targetPorts}];return jsxs("div",{className:classnames(css$2.node__container,{[css$2["is-selected"]]:t}),children:[o,jsxs("div",{className:css$2.node__content,children:[jsx("div",{className:css$2.node__title,children:e.label}),r==null?void 0:r.map(({type:s,value:c})=>(c==null?void 0:c.length)?jsx(PortList,{type:s,value:c},s):null)]})]})},nodeTypes={OperatorNode};var css$1={"main-flow":"_main-flow_1t4yy_1"};const initialElements=[{id:"$flow_slgum",position:{x:966,y:99},type:"OperatorNode",data:{operatorType:"TargetOperator",targetPorts:[{label:"Target",id:"Target"}]},style:{visibility:"visible"}},{id:"$flow_5i9q0",position:{x:530,y:115},type:"OperatorNode",data:{operatorType:"AddOperator",targetPorts:[{label:"Input_1",id:"Input_1"},{label:"Input_2",id:"Input_2"}],sourcePorts:[{label:"Result",id:"Result"}]},style:{visibility:"visible"}},{source:"$flow_x3gaw",sourceHandle:"Source",target:"$flow_5i9q0",targetHandle:"Input_1",id:"reactflow__edge-$flow_x3gawSource-$flow_5i9q0Input_1"},{source:"$flow_qekmc",sourceHandle:"Source",target:"$flow_5i9q0",targetHandle:"Input_2",id:"reactflow__edge-$flow_qekmcSource-$flow_5i9q0Input_2"},{source:"$flow_5i9q0",sourceHandle:"Result",target:"$flow_slgum",targetHandle:"Target",id:"reactflow__edge-$flow_5i9q0Result-$flow_slgumTarget"},{id:"$flow_x3gaw",position:{x:319,y:122},type:"OperatorNode",data:{operatorType:"SourceOperator",sourcePorts:[{label:"Source",id:"Source"}],dataSourceId:"value"},style:{visibility:"visible"}},{id:"$flow_qekmc",position:{x:289,y:229},type:"OperatorNode",data:{operatorType:"SourceOperator",sourcePorts:[{label:"Source",id:"Source"}],dataSourceId:"value2"},style:{visibility:"visible"}}],FlowDiagram=()=>{const{elements:n,setElements:e}=useDiagramsContext();react.exports.useEffect(()=>{e(initialElements)},[]),console.log({elements:n});const t=a=>e(g=>removeElements(a,g)),o=useStoreActions(a=>a.addSelectedElements),r=a=>{const g=addEdge(a,n).filter(d=>!(isEdge(d)&&!isSameSourceHandle(d,a)&&isSameTargetHandle(d,a)));e(g),setTimeout(()=>{const d=g.find(f=>{const _=a;return isEdge(f)&&f.source===_.source&&f.target===_.target&&(f.sourceHandle===_.sourceHandle||!f.sourceHandle&&!_.sourceHandle)&&(f.targetHandle===_.targetHandle||!f.targetHandle&&!_.targetHandle)});o([d].filter(Boolean))})},s=react.exports.useRef(null),c=useStoreActions(a=>a.updateNodePos),u=react.exports.useRef([]);useStoreState(a=>(u.current=a.nodes,u));const i=a=>{var f;const g=a.dataTransfer.getData(MODEL_FORMAT),d=OperatorMap.get(g);if(d){const _=new d,{clientX:j,clientY:M}=a,y=(f=s.current)==null?void 0:f.getBoundingClientRect();y&&(_.position={x:j-y.left,y:M-y.y},_.style={visibility:"hidden"}),e(m=>[...m,_]),setTimeout(()=>{var C;const m=u.current.find(S=>S.id===_.id);if(m){const S={x:((C=m==null?void 0:m.position)==null?void 0:C.x)-(m==null?void 0:m.__rf.width)/2,y:m.position.y-Math.max(m.__rf.height/5,30)};c({id:m.id,pos:S})}e(S=>(S.find(F=>F.id===_.id)&&(_.style={visibility:"visible"}),[...S]))})}},l=a=>{a.dataTransfer.types.includes(MODEL_FORMAT)&&a.preventDefault()};return jsx("div",{className:css$1["main-flow"],ref:s,onDrop:i,onDragEnter:l,onDragOver:l,children:jsxs(ReactFlow,{nodeTypes,elements:n,onElementsRemove:t,onConnect:r,zoomOnScroll:!1,children:[jsx(index$1,{variant:BackgroundVariant.Lines,gap:200,color:"rgba(255,255,255,0.1)",size:1}),jsx(index$2,{}),jsx(index$1$1,{})]})})},AttributePanel=()=>{var u,i;const n=useStoreState(l=>{var a;return(a=l.selectedElements)==null?void 0:a.filter(g=>isNode(g))}),e=n==null?void 0:n[0],t=useDiagramsContextSelector(l=>l.elements.find(a=>a.id===(e==null?void 0:e.id))),o=(u=t==null?void 0:t.data)==null?void 0:u.operatorType,r=OperatorMap.get(o),s=(n==null?void 0:n.length)===1&&o,c=useDiagramsContextSelector(l=>l.updateElement);return jsxs("div",{children:[jsx("div",{children:"Attribute Panel"}),s&&((i=r==null?void 0:r.generateAttributeControl)==null?void 0:i.call(r,{value:t,actions:{updateElement:c}}))]})},DEFAULT_NAMESPACE="";function getFieldConfig(n){return typeof n=="string"?{name:n}:n}function getFieldId(n){return getFieldConfig(n).name||""}const contexts=new Map;function createState(n){const e=new Map,t=new Map,o=new Map,r=new Map,s=new Map,c=new Map;return{name:n,streamMaps:{valueSourceMap:e,instantValueSourceMap:t,changeSourceMap:c,blurSourceMap:o,setValueMap:r,blurValueMap:s},state:{}}}function createContext(n){const e=createState(n);return contexts.set(n,e),e}function getContext(n=DEFAULT_NAMESPACE){return contexts.get(n)||createContext(n)}function getMapFromType(n,e){const t=getFieldConfig(e);return getContext(t.namespace).streamMaps[n]}function setSourceFieldFromType(n,e,t){const o=getMapFromType(n,e),r=getFieldId(e);o.set(r,t)}function getSourceFieldFromType(n,e){const t=getFieldId(e);return getMapFromType(n,e).get(t)}function registerSetValueMethod(n,e){setSourceFieldFromType("setValueMap",n,e)}function useRegisterField(n){const{field:e,setValueMethod:t,value:o}=n;react.exports.useMemo(()=>{registerSetValueMethod(e,t)},[t,getFieldId(e)]),react.exports.useEffect(()=>{var r;(r=getSourceFieldFromType("valueSourceMap",e))==null||r.next(o)},[o])}function isFunction(n){return typeof n=="function"}function Wrap(n){const{children:e,value:t,name:o,onChange:r,namespace:s}=n,c={name:o,namespace:s};useRegisterField({field:c,setValueMethod:r,value:t});function u(l){const a=l.target.value,g=getSourceFieldFromType("instantValueSourceMap",c),d=getSourceFieldFromType("changeSourceMap",c);if(g){g.next(a),d==null||d.next(a);return}d==null||d.next(a),r(a)}function i(l){var a;(a=getSourceFieldFromType("blurSourceMap",c))==null||a.next(l)}return React.Children.only(e)?React.cloneElement(e,{value:t,onChange:u,onBlur:i}):isFunction(e)?e({handleChange:u,handleBlur:i}):jsx(Fragment,{children:e})}const LinkRuntimeContext=React.createContext({store:new Map});function useLinkRuntimeContext(){return react.exports.useContext(LinkRuntimeContext)}function runCode(code){const store=eval(code);return store}const LinkRuntimeContextProvider=n=>{const{value:e,children:t}=n,[o,r]=react.exports.useState(new Map),s=react.exports.useMemo(()=>({store:o}),[o]);return react.exports.useEffect(()=>{if(!e)return;const c=runCode(e);console.log({result:c}),c&&r(c)},[e]),jsx(LinkRuntimeContext.Provider,{value:s,children:t})};function useValue(n){const{store:e}=useLinkRuntimeContext(),t=react.exports.useRef(new Subject);return react.exports.useEffect(()=>{var s;const r=(s=e.get(n))==null?void 0:s.subscribe((...c)=>{t.current.next(...c)});return()=>{r==null||r.unsubscribe(),t.current.next(void 0)}},[e,n]),useObservable(()=>t.current)}const Demo=()=>{const[n,e]=react.exports.useState(""),[t,o]=react.exports.useState(""),r=useValue("$flow_slgum");return jsxs("div",{style:{display:"grid",gap:16},children:[jsx(Wrap,{name:"value",value:n,onChange:e,children:jsx("input",{type:"number"})}),jsx(Wrap,{name:"value2",value:t,onChange:o,children:jsx("input",{type:"number"})}),jsx("output",{children:r})]})},ConsolePanel=()=>{const{elements:n}=useDiagramsState(),[e,t]=react.exports.useState("");return jsxs("div",{children:[jsx("div",{children:"Console Panel"}),jsx("br",{}),jsxs("div",{style:{display:"grid",gap:16},children:[jsx("button",{onClick:()=>{console.log(convertToGraph(n))},children:"graph"}),jsxs("button",{onClick:()=>t(generateLogicState(n)),children:[" ","Compile And Run"," "]})]}),jsxs("div",{children:[jsx("br",{}),jsx(LinkRuntimeContextProvider,{value:e,children:jsx(Demo,{})})]}),jsx("pre",{children:e})]})},container="_container_1hju3_1",main="_main_1hju3_10",console$1="_console_1hju3_13";var css={container,main,console:console$1};const Diagram=()=>jsx("div",{className:css.container,children:jsxs(DiagramsContextProvider,{children:[jsx(OperatorPanel,{}),jsx(FlowDiagram,{}),jsx(AttributePanel,{}),jsx("div",{className:css.console,children:jsx(ConsolePanel,{})})]})});var reset="";function App(){return jsx(Fragment,{children:jsx(Diagram,{})})}ReactDOM.render(jsx(React.StrictMode,{children:jsx(App,{})}),document.getElementById("root"));
